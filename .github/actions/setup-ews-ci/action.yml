name: Setup EWS CI Environment
description: Configure uv, Python, and GitLab Package Registry for EWS packages

inputs:
  python-version:
    description: Python version to install
    required: false
    default: "3.12"
  install-dependencies:
    description: Run uv sync to install dependencies
    required: false
    default: "true"
  ews-credentials:
    description: 'Repository secret EWS_CREDENTIALS - JSON object with all EWS credentials {keys: gitlab_api_read_token, gitlab_api_token, gitlab_package_registry_url, ammonit_or_password, windcube_insights_password   }'
    required: false
    default: ''
  ews-credentials-keys:
    description: 'Repository variable EWS_CREDENTIALS_KEYS - JSON array of expected credential keys for validation'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Setup uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Install Python
      shell: bash
      run: uv python install ${{ inputs.python-version }}

    - name: Setup EWS CI Environment
      shell: bash
      env:
        EWS_CREDENTIALS: ${{ inputs.ews-credentials }}
        EWS_CREDENTIALS_KEYS: ${{ inputs.ews-credentials-keys }}
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        echo "ðŸ”§ Setting up EWS CI environment..."
        
        mkdir -p ~/.config/ews/dataset_registries
        mkdir -p ~/.config/ews/config
        mkdir -p ~/.config/uv
        
        # ============================================================
        # 1. GitHub token (from runner context)
        # ============================================================
        if [ -n "${GITHUB_TOKEN}" ]; then
          cat > ~/.config/ews/config/github.toml <<EOF
        [github]
        username = "${{ github.actor }}"
        email = "noreply@ews-consulting.com"
        token = "${GITHUB_TOKEN}"
        EOF
          chmod 600 ~/.config/ews/config/github.toml
          echo "âœ… Created ~/.config/ews/config/github.toml"
        else
          echo "âš ï¸  No GitHub token available"
        fi
        
        # ============================================================
        # 2. Parse EWS_CREDENTIALS JSON (repository secret)
        # ============================================================
        if [ -n "${EWS_CREDENTIALS}" ]; then
          echo "ðŸ“¦ Parsing EWS_CREDENTIALS JSON..."
          
          # Extract all credentials using jq
          GITLAB_API_TOKEN=$(echo "$EWS_CREDENTIALS" | jq -r '.gitlab_api_token // empty')
          GITLAB_API_READ_TOKEN=$(echo "$EWS_CREDENTIALS" | jq -r '.gitlab_api_read_token // empty')
          GITLAB_PACKAGE_REGISTRY_URL=$(echo "$EWS_CREDENTIALS" | jq -r '.gitlab_package_registry_url // empty')
          AMMONIT_OR_PASSWORD=$(echo "$EWS_CREDENTIALS" | jq -r '.ammonit_or_password // empty')
          WINDCUBE_INSIGHTS_PASSWORD=$(echo "$EWS_CREDENTIALS" | jq -r '.windcube_insights_password // empty')
          
          echo "âœ… Credentials extracted from JSON"
        else
          echo "âš ï¸  No EWS_CREDENTIALS provided"
          GITLAB_API_TOKEN=""
          GITLAB_API_READ_TOKEN=""
          GITLAB_PACKAGE_REGISTRY_URL=""
          AMMONIT_OR_PASSWORD=""
          WINDCUBE_INSIGHTS_PASSWORD=""
        fi
        
        # ============================================================
        # 3. GitLab Package Registry Setup (.netrc + uv.toml)
        # ============================================================
        if [ -n "${GITLAB_API_READ_TOKEN}" ] && [ -n "${GITLAB_PACKAGE_REGISTRY_URL}" ]; then
          echo "ðŸ” Configuring GitLab Package Registry..."
          
          # Create .netrc for HTTP basic auth (used by uv/pip)
          cat > ~/.netrc <<EOF
        machine gitlab.com
        login __token__
        password ${GITLAB_API_READ_TOKEN}
        EOF
          chmod 600 ~/.netrc
          echo "âœ… Created ~/.netrc for gitlab.com"
          
          # Configure uv index with URL from credentials
          cat > ~/.config/uv/uv.toml <<EOF
        [[index]]
        name = "gitlab"
        url = "${GITLAB_PACKAGE_REGISTRY_URL}/simple"
        default = false
        explicit = false
        authenticate = "always"
        ignore-error-codes = [403]
        EOF
          echo "âœ… Configured uv index: gitlab (${GITLAB_PACKAGE_REGISTRY_URL}/simple)"
        else
          echo "â„¹ï¸  No GitLab read token or package registry URL, skipping package registry setup"
        fi
        
        # ============================================================
        # 4. GitLab PyPI Upload (.pypirc for twine)
        # ============================================================
        if [ -n "${GITLAB_API_TOKEN}" ] && [ -n "${GITLAB_PACKAGE_REGISTRY_URL}" ]; then
          cat > ~/.pypirc <<EOF
        [distutils]
        index-servers =
            gitlab
        
        [gitlab]
        repository = ${GITLAB_PACKAGE_REGISTRY_URL}
        username = __token__
        password = ${GITLAB_API_TOKEN}
        EOF
          chmod 600 ~/.pypirc
          echo "âœ… Created ~/.pypirc for GitLab Package Registry publishing (${GITLAB_PACKAGE_REGISTRY_URL})"
        else
          echo "â„¹ï¸  No GitLab API token or package registry URL, skipping .pypirc creation"
        fi
        
        # ============================================================
        # 5. EWS Package Credentials (Ammonit-OR, Windcube Insights)
        # ============================================================
        if [ -n "${AMMONIT_OR_PASSWORD}" ]; then
          cat > ~/.config/ews/config/ammonit-or.toml <<EOF
        [ammonit-or]
        email = "wm@ews-consulting.com"
        password = "${AMMONIT_OR_PASSWORD}"
        EOF
          chmod 600 ~/.config/ews/config/ammonit-or.toml
          echo "âœ… Created ~/.config/ews/config/ammonit-or.toml"
        else
          echo "â„¹ï¸  No Ammonit-OR password"
        fi
        
        if [ -n "${WINDCUBE_INSIGHTS_PASSWORD}" ]; then
          cat > ~/.config/ews/config/windcube-insights.toml <<EOF
        [windcube-insights]
        email = "wm@ews-consulting.at"
        password = "${WINDCUBE_INSIGHTS_PASSWORD}"
        EOF
          chmod 600 ~/.config/ews/config/windcube-insights.toml
          echo "âœ… Created ~/.config/ews/config/windcube-insights.toml"
        else
          echo "â„¹ï¸  No Windcube Insights password"
        fi
        
        # Compatibility: Copy config files to parent directory for old tests
        if ls ~/.config/ews/config/*.toml 1> /dev/null 2>&1; then
          cp ~/.config/ews/config/*.toml ~/.config/ews/
        fi
        
        echo "âœ… EWS CI environment setup complete"

    - name: Install dependencies
      if: inputs.install-dependencies == 'true'
      shell: bash
      run: |
        if [ -f uv.lock ]; then
          echo "ðŸ“¦ Using committed uv.lock"
          uv sync --frozen --all-extras
        else
          echo "ðŸ“¦ No uv.lock found, generating..."
          uv sync --all-extras
        fi
