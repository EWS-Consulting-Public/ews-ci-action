name: Release

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version for build
        type: string
        required: false
        default: "3.12"
      use-nox-publish:
        description: Use 'uvx nox -s publish' instead of direct twine
        type: boolean
        required: false
        default: true
      ews-credentials-keys:
        description: "Repository variable - JSON array of expected credential keys (optional)"
        type: string
        required: false
        default: ""
    secrets:
      EWS_CREDENTIALS:
        description: "Repository secret - JSON object with all EWS credentials"
        required: true

# Note: Caller workflow must set 'permissions: contents: write' or 'permissions: inherit'
# to allow GitHub release creation

jobs:
  release:
    runs-on: ubuntu-latest
    # Only run if:
    # 1. CI workflow completed successfully
    # 2. Triggered by a tag (version release)
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - uses: EWS-Consulting-Public/ews-ci-action/.github/actions/setup-ews-ci@v1
        with:
          python-version: ${{ inputs.python-version }}
          install-dependencies: "false"
          ews-credentials: ${{ secrets.EWS_CREDENTIALS }}
          ews-credentials-keys: ${{ inputs.ews-credentials-keys }}

      - name: Generate lock file for release
        run: |
          if [ -f uv.lock ]; then
            echo "ðŸ“¦ Lock file already exists, using committed version"
          else
            echo "ðŸ“¦ Generating lock file for reproducible release..."
            uv lock
          fi

      - name: Build package
        run: uvx nox -s build

      - name: Publish to GitLab (nox)
        if: ${{ inputs.use-nox-publish }}
        run: uvx nox -s publish

      - name: Publish to GitLab (twine)
        if: ${{ !inputs.use-nox-publish }}
        shell: bash
        env:
          EWS_CREDENTIALS: ${{ secrets.EWS_CREDENTIALS }}
        run: |
          GITLAB_API_TOKEN=$(echo "$EWS_CREDENTIALS" | jq -r '.gitlab_api_token // empty')
          GITLAB_PACKAGE_REGISTRY_URL=$(echo "$EWS_CREDENTIALS" | jq -r '.gitlab_package_registry_url // empty')

          TWINE_USERNAME=__token__ TWINE_PASSWORD="${GITLAB_API_TOKEN}" \
          uvx twine upload \
            --repository-url "${GITLAB_PACKAGE_REGISTRY_URL}" \
            dist/*.whl

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.workflow_run.head_branch }}
          files: |
            dist/*
            uv.lock
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          PACKAGE_NAME=$(grep '^name = ' pyproject.toml | sed 's/name = "\(.*\)"/\1/')
          echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Built files:**" >> $GITHUB_STEP_SUMMARY
          ls -1 dist/ | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Install package" >> $GITHUB_STEP_SUMMARY
          echo "uv pip install $PACKAGE_NAME" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
